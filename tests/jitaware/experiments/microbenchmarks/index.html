<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>Micro-example test</title>
</head>
<body>

<style>
p {
	font-size: 11px;
	font-family: Verdana;
	line-height:110%;
	margin: 0px;
}
</style>
<div id="content">
<p>pattern-1: inconsistent object layout <p>
<br>
<p>pattern-2: polymorphic operations <p>
<br>
<p>pattern-3: create non-contiguous arrays <p>
<br>
<p>pattern-4: accessing uninitialized or deleted array elements <p>
<br>
<p>pattern-5: storing non-numeric values in numeric arrays <p>
<br>
<p>pattern-6: binary operation on undefined<p>
<br>
<b><p>Test results:</p></b>
</div>

<script>

//////////////////// pattern-1 ////////////////////
// inconsistent object layout

var sum = 0;

function pattern1_orig() {
  function Thing(i) {
    var m = i%6;
    if (m === 0) {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } else if (m === 1) {
      this.a = Math.random();
      this.c = Math.random();
      this.b = Math.random();
    } else if (m === 2) {
      this.b = Math.random();
      this.a = Math.random();
      this.c = Math.random();
    } else if (m === 3) {
      this.b = Math.random();
      this.c = Math.random();
      this.a = Math.random();
    } else if (m === 4) {
      this.c = Math.random();
      this.a = Math.random();
      this.b = Math.random();
    } else {
      this.c = Math.random();
      this.b = Math.random();
      this.a = Math.random();
    } 	
  }
	function getSum(base, prop1, prop2, prop3) {
		return base[prop1] + base[prop2] + base[prop3];
	}
	sum = 0;
	for (var i = 0; i < 3000000; i++) {
		sum += getSum(new Thing(i), 'a', 'b', 'c');
	}
}

function pattern1_fix() {
	function Thing(i) {
    var m = i%6;
    if (m === 0) {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } else if (m === 1) {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } else if (m === 2) {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } else if (m === 3) {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } else if (m === 4) {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } else {
      this.a = Math.random();
      this.b = Math.random();
      this.c = Math.random();
    } 	
	}
	function getSum(base, prop1, prop2) {
		return base[prop1] + base[prop2];
	}
	sum = 0;
	for (var i = 0; i < 3000000; i++) {
		sum += getSum(new Thing(i), 'a', 'b');
	}
}

//////////////////// pattern-2 ////////////////////
// polymorphic operations

function pattern2_orig() {
	function f(a, b) {
		return a + b;
	}
	for (var i = 0; i < 5000000; i++) {
		var arg1, arg2;
		if (i % 2 === 0) {
			arg1 = 1; arg2 = 2;
		} else {
			arg1 = 'a';
			arg2 = 'b';
		}
		f(arg1, arg2);	 // function can be called with different types of parameters
	}
}



function pattern2_fix() {
	function g(a, b) {
		return a + b;
	}

	function f(a, b) {
		return a + b;
	}
	for (var i = 0; i < 5000000; i++) {
		var arg1, arg2;
		if (i % 2 === 0) {
			arg1 = 1; arg2 = 2;	
			f(arg1, arg2);
		} else {
			arg1 = 'a';
			arg2 = 'b';
			g(arg1, arg2);
		}
	}
}

//////////////////// pattern-3 ////////////////////
// create non-contiguous arrays

function pattern3_orig() {
	var array = [];
	for (var i = 100000000 - 1; i >= 0; i--) { // initializing array in reverse order makes the array non-contiguous 
		array[i % 50000] = i;
	}
}

function pattern3_fix() {
	var array = [];
	for (var i = 0; i < 100000000; i++) {
		array[i % 50000] = i;
	}
}

//////////////////// pattern-4 ////////////////////
// accessing uninitialized or deleted array elements

function pattern4_orig() {
	var array = [];
	for (var i = 0; i < 100; i++)
		array[i] = 1;
	for (var j = 0; j < 100000; j++) {
		var ij = 0;
		var len = array.length;
		var sum = 0;
    while (array[ij]) { // accessing non-numeric value in the last round, very slow
      sum += array[ij]
			ij++;
		}
	}
}

function pattern4_fix() {
	var array = [];
	for (var i = 0; i < 100; i++)
		array[i] = 1;
	for (var j = 0; j < 100000; j++) {
		var ij = 0;
		var len = array.length;
		var sum = 0;
		while (ij < len) {
			sum += array[ij];
			ij++;
		}
	}
}

//////////////////// pattern-5 ////////////////////
// storing non-numeric values in numeric arrays

var globalarray1, globalarray2;
function pattern5_orig() {
	for (var j = 0; j < 2; j++) {
		var array = [];
		for (var i = 0; i < 10000000; i++)
			array[i] = i;
		array[4] = 2.4; // array data structure switched to accommodate double value
		array[15] = true; // array data structure switched again to accommodate boolean value
		globalarray1 = array;
	}
}

function pattern5_fix() {
	for (var j = 0; j < 2; j++) {
		var array = [];
		for (var i = 0; i < 10000000; i++)
			array[i] = i;
		array[4] = 2;
		array[15] = 1;
		globalarray2 = array;
	}
}

//////////////////// pattern-6 ////////////////////
// binary operation on undefined

function pattern6_orig() {
	var x, y;
	for(var i=0;i<30000000;i++){
		y = x + 2;
	}
}

function pattern6_fix() {
	var x = 0, y;
	for(var i=0;i<30000000;i++){
		y = x + 2;
	}
}

var index = 0;
var tests = [
  [pattern1_orig, pattern1_fix],
	//[pattern2_orig, pattern2_fix],
	//[pattern3_orig, pattern3_fix],
	//[pattern4_orig, pattern4_fix],
	//[pattern5_orig, pattern5_fix],
  //[pattern6_orig, pattern6_fix]
  ];

function runtest(f1, f2) {
	var startTime, endTime,
	print_index = index + 1;
	var time1 = 0, time2 = 0;
	if (index >= tests.length) return;

	//console.time prints result in console,
	// but we need to get the result and return it as a string
	for(var j=0;j<5;j++) {
    startTime = new Date();
		tests[index][1](); // run fixed code
		endTime = new Date();
		time2 += (endTime - startTime);
		
		startTime = new Date();
		tests[index][0](); // run jit unfriendly code
		endTime = new Date();
		time1 += (endTime - startTime);
	}
	
	show('orignal code: ' + time1 + 'ms');
	show('fixed code: ' + time2 + 'ms');

	show('execution time reduction: ' + parseInt(10000 * (time1 - time2) / time1) / 100 + '%')
	show('speedup: ' + parseInt(100 * (time1) / time2) / 100 + 'X');
	if ((++index) < tests.length) {
		show('-------------------------------------');
		show('running pattern-' + (print_index + 1) + '...');
		setTimeout(runtest, 100);
	}
}

var content = document.getElementById('content');
function show(str) {
	var text = document.createElement("p");
	var t = document.createTextNode(str);
	text.appendChild(t);
	content.appendChild(text);
}

// start test
show('running pattern-1...');
setTimeout(runtest, 100);

</script>
</body>
</html>



